What is OAuth?

Oauth is an authorization framework that allows a third party client app to retrieve information about a user from another system usin a token which is valid for alimited amount of time. The application users authorize the third party app to retrieve information on their behalf.

Ideally Oauth is specifiacally meant for \*authorization\*. It can however be used in with an extension known as OpenID Connect which is used for authentication.

![Screenshot from 2023-03-06 07-09-44.png](:/bb4cbe62e3c440f2a32b2016737cab7b)

![Screenshot from 2023-03-06 07-10-03.png](:/111760a2698c42bcaae8bb3c6fce4bdc)

You shouldn't use Oauth for authentication because there's no way to send information back to the client, meaning if the 3rd party app used OAuth for authentication which is a problem. OpenID Connect defines a standard way to return user info by defining a UserInfo endpoint which can be used to access user information.

A few definitions
**Resource Owner** \- the owner of the resource that is being accessed. Say you want to use a third party app and you give google permission to give the app access. You are the resource owner.

**Client** \- accessed protected resources on behalf of the resource owner. This is the 3rd party app that wants access to your resources.

**Resource Server** \- the server hosting the protected resources and is issues the client with the token to access the resources. e.g google or facebook

**Authorization server** \- issues access tokens after successfully authenticating a client and resource owner. e,g facebook, typically though you can have a separate server that does this

**Authorization grant** \- a credential representing the resource owner's authorization to be used by the client to access it;s protected resources used by the client to obtain the access token. OAuth has 4 grant types.

**Authorization Code** \- for some Oauth flows the authorization server does not give the access token directly it first issues an authorization grant, the client sends this grant with the client secret to the authorization server which then sends the access token to the client

**Access token** \- credentials that are used to access protected resources, tokens represent specific scopes and durations of access, granted by the resource owner and enforced by te resource server and authorization server.

**Scope** \- defines the permissions of a token. It defines what resources can be accessed using a given access token. In our example the client app wants to access only images so the images are the scope

OAuth Flows
GRANT TYPE
Grant type is the way an application gets an access token. Each grant type is optimized for a particular use either a web app, native app, server-to-server applications

Authorization Code Grant type
This is the most common OAuth2 grant type.
It is used by both web apps and native apps to get an access token from the authorization server once the user has authorized it. The authorization code flow is the most suitable for websites and mobile apps that have a backend.
This type also has an extra step of exchanging the authorization code for the access token. This exchange takes place in a back channel. This adds a extra layer of security.

HOW IT WORKS

1.  The client app redirects the user to the authorization server's authorization server's endpoint, the client app sends some query parameters which help the authorization in identifying the client app and its intent. The query parameters are:
    - a) `response_type` \- this defines the type of response that is expected. In this flow it will be code.
    - b) `client_id` this parameter defines the id of the client that needs access to the resource(Pics art app's client ID).
    - c) `redirect_uri` this is the uri where the authorization server redirect to once its finished interacting with the resource owner.
    - d) `scope` \- this parameter defines the resources to which access is being requested (not a mandatory parameter ). and if it is not provided the authorization server provides access to default resources already defined for this client.
    - e) `state` the application generates a random string and includes it is in the request.
    the complete request looks like this
    `https://authorization.server.dummy.com/authorize?response_type=code&client_id=12345&redirect_uri=https://client.dummy.com/callback&scope=images_read&state=abcde`
    when the resource owner opens opens this url in the browser the auth server will present them with a prompt asking if they'd like to authorize this application's request.
    
2.  Authorization Response
    if the user gives consent the auth server redirects the browser to the uri provided by the client up in the request, the auth server sends some parameters in the response
    a) code - the authorization code generated by the authorization server. The code is short lived and is bound to the client\_id, scoped and redirect\_uri.
    b) state - same string that was passed with the request
    It looks like this `https://authorization.server.dummy.com/callback?code=hhdf6hsbhjG66hgtgfGGHJGCHJ&state=abcde`
    
3.  token request the client app uses the authorization code it receives to get the access token by sending a post request to the token endpoint. grant\_type - in this flow the value will be authorization\_code. This tells the token endpoint that the client is using the authorization code grant type. code - this is the code sent in the autorization response client\_id - the client apps ID. client\_secret client swcret that verifies that the request is coming from a registered client and not by an attacker posing as a client.
    It looks like this
    

```
POST /token/endpoint HTTP/1.1
 Host: authserver.dummy.com

grant_type=authorization_code
&code=hhdf6hsbhjG66hgtgfGGHJGCHJ
&client_id=12345
&client_secret=gh5Gdkj743HFG45udbfGfs
```

4.  Token Response - the token endpoint verifies all the parameters in the request. It checks that the authorizaton code has not expired and that the client ID and client secret matches. If everything is good then the access token is returned.

```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token":"YT3774ghsghdj6t4GJT5hd",
  "token_type":"bearer",
  "expires_in":3600,
  "refresh_token":"YT768475hjsdbhdgby6434hdh",
  "scope":"images_read"
}
```

![Screenshot from 2023-03-16 09-12-31.png](:/6c8e5a2e524e4547be0a04c388792801)


IMPLICIT GRANT TYPE

Implicit grant type is designed for JavaScript SPAs that dont have a backend.
Because these SPAs have no backend there's no way to store the client secrets, storing the client secret in the JS code isnt safe, coz anyone can access it, we use th eimplicit flow since it just returns the access token directly instead of the authorization code.
the exchange of token happens at the front end an attacker can access the token.

How it works

Step 1 - The client app redirects the user to the authorization server's authorization server's endpoint, with the following parameters included in the request
response_type - this parameter will contain a token, since we are requesting the access token directly.
client_id - The app's client ID
redirect_url - the uri the auth server will redirect to once it has finished interacting with the resource owner
scope - the optional parameter defining the resources being requested
state -optional 

`https://authorization.server.dummy.com/authorize?response_type=token&client_id=12345&redirect_uri=https://client.dummy.com/callback&scope=images.read&state=abcde`

Step 2 - once the user auhtenticated and provides permissions to the authorization server, it will redirect the browser to the redirect_url and athe auth server will then add the token and state to the fragment part of the url

the token is returned in the URL fragment instead of in the query string. the reason for this is to ensure that the app will be able to access the value from the URL.
The response looks like this
`https://authorization.server.dummy.com/callback#access_token=hhdf6hsbhjG66hgtgfGGHJGCHJ&token_type=bearer&expires_in=500&state=abcde`
 This grant does not return a refresh token because the browser has no means of keeping it private.
 
 

![Screenshot from 2023-03-20 07-40-58.png](:/a6e854ca0ae1460eb087760c94f22515)

CLIENT CREDENTIALS GRANT TYPE
This flow is used for machine to machine authorization. There is no user involved in the flow. Typically used my apps using microservice architecture. where different parts of an app are deployed on a different server. One server might require access to some data from the other server. here they can use a client credentials grant type.

Step 1 - Token Request
Since no user is involve the client directly sends a HTTP POST request to the authorization server with the following parameters 

grant_type - will contain the client_credentials
client_id - client_id of the app
client_secret - client secret of the app
scope - optional parameter

POST /token/endpoint HTTP/1.1

  ```
Host: authserver.dummy.com

grant_type=client_credentials
&client_id=12345
&client_secret=gh5Gdkj743HFG45udbfGfs
&scope=images_read
```

Step 2 - Token Response

if the credentials in the request are valid, the auth server returns the token

the response looks like this
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token":"YT3774ghsghdj6t4GJT5hd",
  "token_type":"bearer",
  "expires_in":3600,
  "refresh_token":"YT768475hjsdbhdgby6434hdh",
  "scope":"images_read"
}
```


![Screenshot from 2023-03-20 08-01-08.png](:/ae3167cc41d741e9886d8295371f612d)

RESOURCE OWNER CREDENTIALS GRANT
this flow is used in cases where the resource owner trusts the client and is ready to share its credentials with the client.
this flow was introduced to migrate existing clients using direct authentication schemes such as HTTP Basic or DIgest authentication to OAuth by converting the stored credentials to an access token. ideally toda there's no reason to use this flow. 

Step 1 - Token Request
The client collects the credentials from the user and sends a POST request to the auth server with the following request parameters

response_type - the value for this flow is password
client_id - client_id
client_secret - the client secret
username - username of the user
password - user password
scope - defines the resources being accessed.
```
POST /token/endpoint HTTP/1.1

  Host: authserver.dummy.com

grant_type=password
&client_id=12345
&client_secret=gh5Gdkj743HFG45udbfGfs
&username=Jone@xyz.com
&password=abcde
&scope=images_read
```

Step 2 - token response
if the client credentials are valid then the auth server returns a token that looks like this
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token":"YT3774ghsghdj6t4GJT5hd",
  "token_type":"bearer",
  "expires_in":3600,
  "refresh_token":"YT768475hjsdbhdgby6434hdh",
  "scope":"images_read"
}
```



![Screenshot from 2023-03-20 08-24-20.png](:/8766fc3bcfaf43878444268f94d7e770)

REFRESH TOKEN GRANT
Since the access token expires periodically for security purposes, a refresh token is a token that can be used to get the access token when it expires.
Refresh tokens have different settings usually designed by the authorization server. Typically the refresh token expires after some time, but typicaaly has a longer expiration that the access token.

Refresh tokens have strict storage requirements to ensure they are not leaked, they can also be blackilisted by the auth server

How it works 
Step 1 - Refresh token request
if the client already has a refresh token, then it can exchang ethe refresh token for an access token by makin a HTTP POST request to the authorization server with the following parameters
grant_type - the calue here is refresh_token
refresh_token - refresh token
client_id - client id
client_secret - client secret
```
POST /oauth/v2/accessToken HTTP/1.1
Host: authserver.dummy.com
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&refresh_token=k3hjJE5x1lZh-zjU-02w8EJW6l2jnuP8F1uXMgkm8nzjPfnaJR
&client_id=12345
&client_secret=hhdHFgggdFGfhd


```

Step 2 Refresh token response

If the request credentials are valid then and the refresh token is not expired, then an access token is returned, 
the reponse from the authorization server is included

```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token": "dgfYTGFVygPtyqytVfyGFtyF",
  "expires_in": 3600,
  "refresh_token": "GHcdkHJjcbhhBHJGbhjfgkHghB",
  "refresh_token_expires_in": 500000
}
```

![Screenshot from 2023-03-20 08-44-30.png](:/67a246b732d9411b8f30792b39d6639e)

Which flows dont allow refresh token grants?
Implicit grant type - In this grant type, the client is not able to store the client_secret. We can’t expect that it will be able to store the refresh token, which is highly confidential. Therefore, this flow doesn’t support refresh token grant flow.

Client credentials grant type - In this grant type there is no user, so the need for refresh token doesn’t arise. The client can just send its client id and client secret to get the access token.
